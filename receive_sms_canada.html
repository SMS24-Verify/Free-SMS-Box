<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Receive SMS - Canada Number</title>
  <!-- Tailwind CSS CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom styles for the app */
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6; /* Light gray background */
    }
    .header-bg {
      background-color: #1a73e8; /* Google Blue */
    }
    .nav-bg {
      background-color: #333;
    }
    .message-container {
      background-color: #ffffff;
      border-radius: 0.75rem; /* rounded-xl */
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
      padding: 1.5rem; /* p-6 */
      display: flex;
      flex-direction: column;
      max-height: 60vh; /* Limit height and enable scrolling */
      overflow-y: auto;
    }
    .message-bubble {
      background-color: #e2e8f0; /* Light gray for message bubbles */
      border-radius: 0.75rem; /* rounded-lg */
      padding: 0.75rem 1rem; /* p-3 px-4 */
      margin-bottom: 0.75rem; /* mb-3 */
      word-wrap: break-word; /* Ensure long words break */
      max-width: 80%; /* Limit bubble width */
      align-self: flex-start; /* Default to incoming */
    }
    .message-bubble.incoming {
      background-color: #d1fae5; /* Light green for incoming messages */
      align-self: flex-start;
    }
    .message-bubble.outgoing {
      background-color: #bfdbfe; /* Light blue for outgoing messages (if applicable) */
      align-self: flex-end;
    }
    .refresh-button {
      background-color: #28a745; /* Green */
      transition: background-color 0.2s ease-in-out;
    }
    .refresh-button:hover {
      background-color: #218838;
    }
    .back-button {
      background-color: #4a5568; /* Dark gray */
      transition: background-color 0.2s ease-in-out;
    }
    .back-button:hover {
      background-color: #2d3748;
    }
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Ad containers - to collapse when empty */
    .ad-slot {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      text-align: center;
      width: 100%;
      transition: max-height 0.5s ease-out, opacity 0.5s ease-out, margin 0.5s ease-out;
      overflow: hidden;
      max-height: 500px;
      opacity: 1;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    .ad-slot.collapsed {
      max-height: 0;
      margin-top: 0;
      margin-bottom: 0;
      opacity: 0;
    }
    .ad-slot iframe {
      border: none;
      display: block;
      overflow: hidden;
      width: 1px;
      height: 1px;
      opacity: 0;
      transition: width 0.5s ease-out, height 0.5s ease-out, opacity 0.5s ease-out;
    }
    #native-ad-slot.grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      justify-items: center;
      align-items: flex-start;
    }
    #native-ad-slot.grid-container iframe {
        width: 1px;
        height: 1px;
        opacity: 0;
    }
    .copy-button {
        background: none;
        border: none;
        color: #1a73e8;
        cursor: pointer;
        font-size: 1.2rem;
        margin-left: 0.5rem;
        padding: 0;
        vertical-align: middle;
        transition: color 0.2s;
    }
    .copy-button:hover {
        color: #0b5ed7;
    }
    .copy-button:active {
        transform: translateY(1px);
    }
    .copy-button.copied {
        color: #28a745; /* Green when copied */
    }
    .direct-link-container {
      margin-top: 15px;
      margin-bottom: 30px;
      text-align: center;
    }
    .direct-link-container a {
      color: #1a73e8;
      font-weight: bold;
      text-decoration: underline;
    }
  </style>

  <!-- Popunder Adsterra Code -->
  <script type='text/javascript' src='//pl27076189.profitableratecpm.com/bd/9d/a0/bd9da0ea1fb5ebaf0db6f76aa02c0300.js'></script>
  <!-- End Popunder Adsterra Code -->

</head>
<body class="min-h-screen flex flex-col">

  <!-- Header Section -->
  <header class="header-bg text-white p-6 text-center text-3xl font-bold rounded-b-lg shadow-md">
    <div class="flex items-center justify-center relative">
      <a href="canada.html" class="absolute left-4 text-white text-xl hover:text-blue-200 transition-colors">
        &larr; Back
      </a>
      <span>Receive SMS</span>
      <!-- The number below "Receive SMS" is removed as per request -->
    </div>
  </header>

  <!-- Navigation Bar (Copied from uk.html) -->
  <nav class="nav-bg p-4 text-center shadow-sm">
    <a href="index.html" class="text-white mx-4 text-lg font-semibold hover:text-blue-200 transition-colors">Home</a>
    <a href="#" class="text-white mx-4 text-lg font-semibold hover:text-blue-200 transition-colors">About Us</a>
    <a href="#" class="text-white mx-4 text-lg font-semibold hover:text-blue-200 transition-colors">Contact</a>
  </nav>

  <main class="flex-grow container mx-auto p-6">
    <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center flex items-center justify-center">
      Messages for <span id="current-number-display" class="mx-2">+1 416 123 4567</span>
      <button id="copy-number-button" class="copy-button" title="Copy number">
        ðŸ“‹ <!-- Clipboard icon (Emoji) -->
      </button>
    </h3>

    <!-- Adsterra Native Banner (Placed below the number as requested) -->
    <div id="native-ad-slot" class="ad-slot mx-auto grid-container">
      <!-- Ad Code will be inserted here by JavaScript -->
    </div>
    <!-- End Adsterra Native Banner -->

    <!-- Message List Container -->
    <div id="messages-list" class="message-container">
      <!-- Messages will be loaded here by JavaScript -->
    </div>

    <!-- Refresh Button -->
    <div class="flex justify-center mt-6">
      <button onclick="refreshMessages()" class="refresh-button text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center">
        <span id="refreshButtonText">Refresh Messages</span>
        <span id="loadingSpinner" class="loading-spinner hidden"></span>
      </button>
    </div>

    <!-- Adsterra Banner 728x90 (Placed after Refresh Messages button as requested) -->
    <div id="banner-728x90-ad-slot" class="ad-slot mx-auto mt-6">
      <!-- Iframe for Banner 728x90 Ad Code will be inserted here by JavaScript -->
    </div>
    <!-- End Adsterra Banner -->

    <!-- Direct Link Text (Re-added as per request) -->
    <div class="direct-link-container">
      <p>
        <a href="https://www.profitableratecpm.com/rpyik3mwtc?key=2d55950f1a1ec397c4aa2852ea2ae6a6" target="_blank">
          Click here to see our other services!
        </a>
      </p>
    </div>

  </main>

  <!-- Footer Section -->
  <footer class="bg-gray-800 text-white p-6 text-center text-sm mt-10 rounded-t-lg shadow-md">
    &copy; 2025 Free SMS Box. All rights reserved.
  </footer>

  <!-- Social Bar Adsterra Code (Already present, confirming placement) -->
  <script type='text/javascript' src='//pl27076196.profitableratecpm.com/88/a6/4b/88a64b874b1a42ceee80beec24d7f611.js'></script>
  <!-- End Social Bar Adsterra Code -->

  <script type="module">
    // Firebase SDK Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, where, addDoc, onSnapshot, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let currentNumber = ''; // Store the currently displayed number
    let db; // Firestore instance
    let auth; // Auth instance
    let userId; // User ID for Firestore paths

    // Define ad configurations
    const adConfigs = {
      native: {
        scripts: [
          { async: true, 'data-cfasync': false, src: '//pl27076176.profitableratecpm.com/36c71a4fca369dbf689c31baada8259d/invoke.js' }
        ],
        divs: [
          { id: 'container-36c71a4fca369dbf689c31baada8259d' }
        ],
        height: 250, // Default or flexible height for native ads
        width: 300   // Default or flexible width for native ads
      },
      banner728x90: { // Configuration for 728x90 banner
        key: 'dba9c0c7da688537036a970dd8eb8984',
        height: 90,
        width: 728
      }
    };

    /**
     * Loads an advertisement within an iframe to isolate its scripts and prevent layout shifts.
     * @param {string} containerId - The ID of the HTML element where the iframe will be appended.
     * @param {object} adConfig - Configuration object for the ad.
     */
    function loadAdInIframe(containerId, adConfig) {
      const container = document.getElementById(containerId);
      if (!container) return;

      container.classList.remove('collapsed');
      container.innerHTML = '';

      const iframes = [];

      if (adConfig.scripts && adConfig.divs && containerId === 'native-ad-slot') {
        // Specific handling for native ad scripts and divs
        adConfig.divs.forEach((divData, index) => {
          const iframe = document.createElement('iframe');
          iframe.style.width = '1px';
          iframe.style.height = '1px';
          iframe.style.opacity = '0';
          iframe.style.border = 'none';
          iframe.style.overflow = 'hidden';
          iframe.scrolling = 'no';
          iframe.setAttribute('loading', 'lazy');
          iframe.classList.add('native-ad-iframe');

          container.appendChild(iframe);
          iframes.push(iframe);

          const iframeDoc = iframe.contentWindow.document;
          iframeDoc.open();
          iframeDoc.write(`
            <!DOCTYPE html>
            <html>
            <head>
              <style>body { margin: 0; overflow: hidden; }</style>
            </head>
            <body>
              <div id="${divData.id}"></div>
            </body>
            </html>
          `);
          iframeDoc.close();

          const scriptData = adConfig.scripts[index];
          if (scriptData) {
            const script = iframeDoc.createElement('script');
            script.type = 'text/javascript';
            if (scriptData.src) {
              script.src = scriptData.src;
              if (scriptData.async !== undefined) script.async = scriptData.async;
              if (scriptData['data-cfasync'] !== undefined) script.dataset.cfasync = scriptData['data-cfasync'];
            } else if (scriptData.textContent) {
              script.textContent = scriptData.textContent;
            }
            iframeDoc.body.appendChild(script);
          }
        });
      } else {
        // Generic handling for other banner ads
        const iframe = document.createElement('iframe');
        iframe.style.width = '1px';
        iframe.style.height = '1px';
        iframe.style.opacity = '0';
        iframe.style.border = 'none';
        iframe.style.overflow = 'hidden';
        iframe.scrolling = 'no';
        iframe.setAttribute('loading', 'lazy');

        container.appendChild(iframe);
        iframes.push(iframe);

        const iframeDoc = iframe.contentWindow.document;
        iframeDoc.open();
        iframeDoc.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <style>body { margin: 0; overflow: hidden; }</style>
          </head>
          <body>
            <div id="ad-content-wrapper"></div>
          </body>
          </html>
        `);
        iframeDoc.close();

        const adContentWrapper = iframeDoc.getElementById('ad-content-wrapper');

        if (adConfig.key) {
          const scriptOptions = iframeDoc.createElement('script');
          scriptOptions.type = 'text/javascript';
          scriptOptions.textContent = "atOptions = {" +
            "'key' : '" + adConfig.key + "'," +
            "'format' : 'iframe'," +
            "'height' : " + adConfig.height + "," +
            "'width' : " + adConfig.width + "," +
            "'params' : {}" +
            "};";
          adContentWrapper.appendChild(scriptOptions);

          const scriptInvoke = iframeDoc.createElement('script');
          scriptInvoke.type = 'text/javascript';
          scriptInvoke.src = `//www.highperformanceformat.com/${adConfig.key}/invoke.js`;
          adContentWrapper.appendChild(scriptInvoke);
        }
      }

      setTimeout(() => {
        let anyAdLoaded = false;
        iframes.forEach(iframe => {
          try {
            // Check if iframe content has loaded and has significant height
            if (iframe.contentWindow && iframe.contentWindow.document && iframe.contentWindow.document.body.scrollHeight > 50) {
              iframe.style.width = `${adConfig.width}px`;
              iframe.style.height = `${adConfig.height}px`;
              iframe.style.opacity = '1';
              anyAdLoaded = true;
            } else {
              // If ad failed to load, collapse the iframe
              iframe.style.width = '0px';
              iframe.style.height = '0px';
              iframe.style.opacity = '0';
            }
          } catch (e) {
            // Catch cross-origin errors if content is inaccessible
            iframe.style.width = '0px';
            iframe.style.height = '0px';
            iframe.style.opacity = '0';
          }
        });

        // If no ads loaded, collapse the parent container
        if (!anyAdLoaded) {
          container.classList.add('collapsed');
        } else {
          container.classList.remove('collapsed');
        }
      }, 1500); // Give ads some time to load
    }

    /**
     * Loads advertisements into their respective containers.
     */
    function loadAds() {
      const nativeAdSlotContainer = document.getElementById('native-ad-slot');
      const banner728x90AdSlotContainer = document.getElementById('banner-728x90-ad-slot');

      if (nativeAdSlotContainer) {
        nativeAdSlotContainer.innerHTML = '';
        nativeAdSlotContainer.classList.add('collapsed'); // Start collapsed
        loadAdInIframe('native-ad-slot', adConfigs.native);
      }
      if (banner728x90AdSlotContainer) {
        banner728x90AdSlotContainer.innerHTML = '';
        banner728x90AdSlotContainer.classList.add('collapsed'); // Start collapsed
        loadAdInIframe('banner-728x90-ad-slot', adConfigs.banner728x90);
      }
    }

    /**
     * Function to format time difference from a Firestore Timestamp.
     * @param {object} timestamp - Firestore Timestamp object.
     * @returns {string} Formatted time string (e.g., "Just now", "5 minutes ago", "2 hours ago", "3 days ago").
     */
    function formatTimeAgo(timestamp) {
        if (!timestamp || !timestamp.toDate) {
            return "Unknown time";
        }
        const now = new Date();
        const messageDate = timestamp.toDate(); // Convert Firestore Timestamp to Date object
        const diffSeconds = Math.floor((now - messageDate) / 1000);

        if (diffSeconds < 60) {
            return "Just now";
        } else if (diffSeconds < 3600) {
            const minutes = Math.floor(diffSeconds / 60);
            return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        } else if (diffSeconds < 86400) {
            const hours = Math.floor(diffSeconds / 3600);
            return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        } else {
            const days = Math.floor(diffSeconds / 86400);
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }
    }

    /**
     * Generates a single dummy message object (without time, as Firestore will add timestamp).
     * @returns {object} A dummy message object.
     */
    function generateSingleDummyMessage() {
        const platforms = [
            "Google", "Facebook", "Amazon", "Netflix", "Spotify", "PayPal", "eBay", "LinkedIn",
            "WhatsApp", "Instagram", "TikTok", "Twitter", "Banking App", "Your Bank", "Online Store", "Service Provider"
        ];

        const messageTemplates = [
            "Your verification code is {code}. Do not share this code.",
            "OTP for your transaction is {code}. Valid for 5 mins.",
            "New notification from {platform}: '{content}'. Tap to view.",
            "Your {platform} account security alert: Unusual login detected. If this wasn't you, reset password.",
            "Reminder: Your bill from {platform} is due in 2 days. Amount: ${amount}.",
            "Your order #{orderId} from {platform} has been shipped. Track here: {link}",
            "Welcome to {platform}! Your account is now active.",
            "You have a new message from {platform}. Check your inbox.",
            "Your password reset link: {link}. Valid for 15 minutes.",
            "Special offer from {platform}: Get {discount}% off your next purchase! Use code {promoCode}."
        ];

        const randomPlatform = platforms[Math.floor(Math.random() * platforms.length)];
        const randomTemplate = messageTemplates[Math.floor(Math.random() * messageTemplates.length)];
        const code = Math.floor(100000 + Math.random() * 900000); // 6-digit code
        const orderId = Math.floor(10000 + Math.random() * 90000); // 5-digit order ID
        const amount = (Math.random() * 100 + 10).toFixed(2); // Random amount
        const discount = Math.floor(Math.random() * 20) + 10; // 10-30%
        const promoCode = `SAVE${Math.floor(Math.random() * 900) + 100}`; // Random promo code
        const link = `https://example.com/link${Math.floor(Math.random() * 1000)}`;

        let content = randomTemplate;
        content = content.replace("{code}", code);
        content = content.replace("{platform}", randomPlatform);
        content = content.replace("{orderId}", orderId);
        content = content.replace("{amount}", amount);
        content = content.replace("{discount}", discount);
        content = content.replace("{promoCode}", promoCode);
        content = content.replace("{link}", link);

        if (content.includes("{content}")) {
            const genericContents = [
                "Your account has been updated.",
                "New activity detected on your account.",
                "Your appointment is confirmed.",
                "You have a new friend request.",
                "New trending topic: #DailyNews",
                "Important security notification."
            ];
            content = content.replace("{content}", genericContents[Math.floor(Math.random() * genericContents.length)]);
        }

        return {
            from: randomPlatform,
            content: content
        };
    }

    /**
     * Fetches and displays messages for the current number from Firestore.
     * Sets up a real-time listener using onSnapshot.
     */
    function displayMessages() {
      if (!db || !userId || !currentNumber) {
        console.warn("Firestore not initialized or current number not set.");
        return;
      }

      const messagesList = document.getElementById('messages-list');
      messagesList.innerHTML = ''; // Clear existing messages

      const messagesCollectionRef = collection(db, `artifacts/${__app_id}/public/data/sms_messages_canada`);
      // Removed orderBy from query to avoid index issues. Sorting will be done client-side.
      const q = query(messagesCollectionRef, where("number", "==", currentNumber));

      onSnapshot(q, async (snapshot) => {
        if (snapshot.empty) {
          console.log("No messages found in Firestore for this number. Adding initial dummy messages.");
          const initialMessages = [];
          for (let i = 0; i < 8; i++) {
              initialMessages.push(generateSingleDummyMessage());
          }

          for (const msg of initialMessages) {
              await addDoc(messagesCollectionRef, {
                  number: currentNumber,
                  from: msg.from,
                  content: msg.content,
                  timestamp: serverTimestamp()
              });
          }
        } else {
          messagesList.innerHTML = ''; // Clear again to re-render all messages
          const fetchedMessages = [];
          snapshot.docs.forEach(doc => {
            fetchedMessages.push(doc.data());
          });

          // Sort messages by timestamp in descending order (latest first)
          fetchedMessages.sort((a, b) => {
              if (a.timestamp && b.timestamp) {
                  return b.timestamp.toDate() - a.timestamp.toDate();
              }
              return 0;
          });

          fetchedMessages.forEach(msg => {
            const timeAgo = formatTimeAgo(msg.timestamp); // Use Firestore timestamp
            const messageHtml = `
              <div class="message-bubble incoming">
                <p class="text-sm font-semibold text-gray-700">From: ${msg.from}</p>
                <p class="text-gray-800 mt-1">${msg.content}</p>
                <p class="text-xs text-gray-500 text-right mt-1">${timeAgo}</p>
              </div>
            `;
            messagesList.insertAdjacentHTML('beforeend', messageHtml);
          });
          messagesList.scrollTop = messagesList.scrollHeight; // Scroll to bottom
        }
      }, (error) => {
        console.error("Error fetching messages:", error);
        messagesList.innerHTML = '<p class="text-center text-red-500 mt-4">Error loading messages. Please try again.</p>';
      });
    }

    /**
     * Simulates fetching and displaying new messages for the current number.
     * In a real application, this would involve an API call to fetch messages for the specific number.
     */
    async function refreshMessages() {
      const refreshButtonText = document.getElementById('refreshButtonText');
      const loadingSpinner = document.getElementById('loadingSpinner');

      if (!db || !currentNumber) {
          console.error("Firestore not initialized or current number not set.");
          return;
      }

      refreshButtonText.textContent = 'Refreshing...';
      loadingSpinner.classList.remove('hidden');

      try {
          const newMessageData = generateSingleDummyMessage();
          const messagesCollectionRef = collection(db, `artifacts/${__app_id}/public/data/sms_messages_canada`);
          await addDoc(messagesCollectionRef, {
              number: currentNumber,
              from: newMessageData.from,
              content: newMessageData.content,
              timestamp: serverTimestamp() // Firestore will set the server timestamp
          });
      } catch (error) {
          console.error("Error adding new message:", error);
      } finally {
          refreshButtonText.textContent = 'Refresh Messages';
          loadingSpinner.classList.add('hidden');
      }
    }

    /**
     * Copies the currently displayed phone number to the clipboard.
     */
    function copyNumber() {
      const numberToCopy = document.getElementById('current-number-display').textContent;
      const copyButton = document.getElementById('copy-number-button');

      const textArea = document.createElement("textarea");
      textArea.value = numberToCopy;
      textArea.style.position = "fixed";
      textArea.style.left = "-999999px";
      textArea.style.top = "-999999px";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          copyButton.classList.add('copied');
          setTimeout(() => {
            copyButton.classList.remove('copied');
          }, 1500);
        } else {
          console.error('Failed to copy text using execCommand.');
        }
      } catch (err) {
        console.error('Error attempting to copy text:', err);
      }
      document.body.removeChild(textArea);
    }


    // When the page loads, set the number and display messages
    document.addEventListener('DOMContentLoaded', async () => {
      const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
      console.log("Firebase Config:", firebaseConfig);
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      console.log("Firebase App, DB, Auth initialized.");

      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
          console.log("Signed in with custom token.");
        } else {
          await signInAnonymously(auth);
          console.log("Signed in anonymously.");
        }
        userId = auth.currentUser?.uid || crypto.randomUUID();
        console.log("Firebase authenticated. User ID:", userId);
      } catch (error) {
        console.error("Firebase authentication failed:", error);
      }

      const urlParams = new URLSearchParams(window.location.search);
      currentNumber = urlParams.get('number') || '+1 416 123 4567';

      document.getElementById('current-number-display').textContent = currentNumber;

      document.getElementById('copy-number-button').addEventListener('click', copyNumber);

      displayMessages();
      loadAds();
    });
  </script>

</body>
</html>
